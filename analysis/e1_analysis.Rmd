---
title: "Social Referencing and Uncertainty"
author: "Emily & Mike"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    number_sections: true
---

<style type="text/css">
body, td {
   font-size: 14px;
}
code {
  font-size: 11px;
}
pre {
  font-size: 11px;
}
</style>

Data analysis of social referencing and uncertainty study.

# Data preprocessing

Preliminaries.

```{r echo=FALSE}
rm(list=ls())
knitr::opts_chunk$set(fig.width=8, fig.height=5, 
                      echo=TRUE, warning=FALSE, message=FALSE, cache=TRUE)
suppressPackageStartupMessages(c("dplyr","langcog","tidyr","ggplot2","lme4"))
library(langcog)
library(dplyr)
library(ggplot2)
library(rjson)
library(stringr)
library(tidyr)
library(lme4)
library(xtable)
theme_set(theme_bw())
```

Read in files and consolidate to the same directory. 

```{r}
files <- dir("../datavyu/data/")
d.raw <- data.frame()

for (f in files) {
  jf <- paste("../datavyu/data/",f,sep="")
  jd <- read.csv(jf)
  id <- data.frame(SID = f,
                   line = jd$phase.ordinal,
                   phase = as.numeric(jd$phase.1_2_3_4),
                   social_ref = as.numeric(jd$reference.0_1),
                   phase_onset = jd$phase.onset,
                   phase_offset = jd$phase.offset)
  d.raw <- bind_rows(d.raw, id)
}

d.raw$SID <- str_replace(d.raw$SID, ".csv", "")

```

Read in trial info and demographics. 

```{r}
demo <- read.csv("../soc_ref_uncertainty_EH_demo2016.csv") 
demo$age_years <- round(demo$age, 0)

trial_info <- read.csv("trial_info.csv")
```

Join trial info and demographics with raw data.

```{r}
d <- left_join(d.raw, demo) %>%
  select(SID, phase, social_ref, age_years, line, Condition, phase_onset, phase_offset) %>%
  mutate(phase_length = phase_offset - phase_onset) %>%
  left_join(trial_info, by = c("Condition","line")) %>%
  mutate(phase_name = factor(phase, levels = 1:4, 
                             labels = c("label-request","request-slide",
                                        "slide-touch","touch-response"))) 


```

Create tidy data "ds".

```{r}
ds <- d %>%
  select(SID, phase, social_ref, trial_type, phase_name, age_years) %>%
  separate(col = "trial_type", into = c("num_objs","familiarity"), sep = "_") 
```

Plot social referencing by familiarity and # items.

```{r}
mss <- ds %>%
  group_by(SID, phase_name, num_objs, familiarity, age_years) %>%
  summarise(social_ref = mean(social_ref))

ms <- ds %>%
  group_by(phase_name, familiarity, num_objs, age_years) %>%
  multi_boot_standard(col = "social_ref") 

ggplot(mss, aes(x = phase_name, y = social_ref, 
               col = familiarity, group = familiarity)) + 
  geom_jitter(width = .3, height = .05) +
  geom_line(data = ms, aes(y = mean)) + 
  geom_pointrange(data = ms, 
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width =.1)) + 
  facet_grid(age_years ~ num_objs) + 
  ylim(c(0,1)) + 
  xlab("") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))

```

Get phase lengths and redo plot to include. 

```{r}
phase_lengths <- d %>% 
  group_by(phase_name) %>% 
  summarise(phase_length = mean(phase_length)) %>%
  mutate(time = cumsum(phase_length),
         middle_time = time - phase_length/2, 
         middle_time_s = middle_time / 1000)

ms <- left_join(ms, phase_lengths)
mss <- left_join(mss, phase_lengths)

ggplot(mss, aes(x = middle_time_s, y = social_ref, 
               col = familiarity, group = familiarity)) + 
  geom_jitter(width = .4, height = .05) +
  geom_line(data = ms, aes(y = mean)) + 
  geom_pointrange(data = ms, 
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width =.1)) + 
  facet_grid(.~num_objs) + 
  ylim(c(0,1)) + 
  xlim(c(0, 9)) + 
  xlab("Time (s)") + 
  ylab("Probability of social referencing") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

#Basic analyses
```{r}
lm <- glmer(social_ref ~ num_objs * familiarity * phase_name * age_years +
              (1|SID),
              data = ds, 
              family = "binomial")
              
glmer_table <- xtable(coef(summary(lm)), caption = "Fixed-effect coefficients for logistic mixed effects model predicting social referencing in Experiment 1.") 

glmer_table
```





