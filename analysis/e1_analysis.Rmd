---
title: "Social Referencing and Uncertainty"
author: "Emily & Mike"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    number_sections: true
---

<style type="text/css">
body, td {
   font-size: 14px;
}
code {
  font-size: 11px;
}
pre {
  font-size: 11px;
}
</style>

Data analysis of social referencing and uncertainty study.

# Data preprocessing

Preliminaries.

```{r echo=FALSE}
rm(list=ls())
knitr::opts_chunk$set(fig.width=8, fig.height=5, 
                      echo=TRUE, warning=FALSE, message=FALSE, cache=TRUE)
suppressPackageStartupMessages(c("dplyr","langcog","tidyr","ggplot2","lme4"))
library(langcog)
library(dplyr)
library(ggplot2)
library(rjson)
library(stringr)
library(tidyr)
library(lme4)
library(xtable)
library(knitr)
library(markdown)
theme_set(theme_bw())
```

Read in files and consolidate to the same directory. 

```{r}
d.raw <- data.frame()
files <- dir("../data/coder_1")

for (f in files) {
  jf <- paste("../data/coder_1/",f,sep="")
  jd <- read.csv(jf)
  id <- data.frame(SID = f,
                   line = jd$phase.ordinal,
                   phase = as.numeric(jd$phase.1_2_3_4),
                   phase_onset = jd$phase.onset,
                   phase_offset = jd$phase.offset, 
                   num_looks = jd$reference.num_looks,
                   exclude = as.numeric(jd$reference.exclude))
  d.raw <- bind_rows(d.raw, id)
}

files <- dir("../data/coder_2")
for (f in files) {
  jf <- paste("../data/coder_2/",f,sep="")
  jd <- read.csv(jf)
  id <- data.frame(SID = f,
                   line = as.numeric(jd$phase.ordinal),
                   phase = as.numeric(jd$phase.1_2_3_4),
                   phase_onset = as.numeric(jd$phase.onset),
                   phase_offset = as.numeric(jd$phase.offset), 
                   num_looks = as.numeric(jd$reference.num_looks),
                   exclude = as.numeric(jd$reference.exclude))
  d.raw <- bind_rows(d.raw, id)
}

d.raw$SID <- str_replace(d.raw$SID, ".csv", "")

d.raw <- distinct(d.raw, SID, line)


```

Read in trial info and demographics. 

```{r}
demo <- read.csv("../soc_ref_uncertainty_EH_demo2016.csv") 
demo$age <- str_replace(demo$age, "n/a", "")
demo$age <- str_replace(demo$age, "N/A", "")
demo$english <- str_replace(demo$english, "n/a", "")
demo$english <- str_replace(demo$english, "N/A", "")
demo$age <- as.numeric(demo$age)
demo$age_years <- trunc(demo$age, digits = 0)
demo$age_months <- demo$age*12
demo$Condition <- str_replace(demo$Condition, " ", "")

trial_info <- read.csv("trial_info.csv")
```

Join trial info and demographics with raw data.

```{r}
d <- left_join(d.raw, demo) %>%
  select(SID, phase, num_looks, exclude, age_years, age_months, gender, line, Condition, phase_onset, phase_offset, english) %>%
  mutate(phase_length = phase_offset - phase_onset) %>%
  mutate(social_ref = as.numeric(num_looks>0))%>%
  left_join(trial_info, by = c("Condition","line"))%>%
  mutate(first_half = between(trial, 1, 4)) 

d <- d %>%
  filter(phase_length > 50) %>%
  mutate(looks_sec = (num_looks/phase_length)*1000) %>%
  mutate(bilingual = (english < 95))
```

Calculate social ref, num looks, and exclude for a new phase that collapses across phases 2-3
```{r}
sr_phase <- d %>%
    select(SID, trial, social_ref, phase_name) %>%
    group_by(SID, trial) %>%
    spread(phase_name, social_ref) %>%
    mutate(request_touch = pmax(request_slide, slide_touch))%>%
    gather("phase_name", "social_ref", label_request:request_touch)
    
nl_phase <- d %>%
    select(SID, trial, num_looks, phase_name) %>%
    group_by(SID, trial) %>%
    spread(phase_name, num_looks) %>%
    mutate(request_touch = request_slide + slide_touch)%>%
    gather("phase_name", "num_looks", label_request:request_touch)

ex_phase <- d %>%
    select(SID, trial, exclude, phase_name) %>%
    group_by(SID, trial) %>%
    spread(phase_name, exclude) %>%
    mutate(request_touch = pmax(request_slide, slide_touch))%>%
    gather("phase_name", "exclude", label_request:request_touch)

lgth_phase <- d %>%
    select(SID, trial, phase_name, phase_length) %>%
    group_by(SID, trial) %>%
    spread(phase_name, phase_length) %>%
    mutate(request_touch = pmax(request_slide, slide_touch))%>%
    gather("phase_name", "phase_length", label_request:request_touch)
    
```

Create dataframe with new phase collapsed across phases 2 and 3
```{r}
dc <- d %>%
  select(SID, trial, social_ref, phase_name, phase_length, familiarity, num_objs, age_months, age_years) %>%
  spread(phase_name, social_ref) %>%
  mutate(request_touch = NA)%>%
  group_by(SID, trial)%>%
  select(SID, trial, familiarity, num_objs, age_months, age_years, label_request, request_touch, touch_response)%>%
  gather("phase_name", "social_ref", label_request:touch_response)%>%
  select(SID, trial, familiarity, num_objs, age_months, age_years, phase_name)%>%
  left_join(sr_phase, by = c("SID", "trial", "phase_name"))%>%
  left_join(nl_phase, by = c("SID", "trial", "phase_name"))%>%
  left_join(ex_phase, by = c("SID", "trial", "phase_name"))%>%
  left_join(lgth_phase, by = c("SID", "trial", "phase_name"))

```

Plot social referencing by familiarity and # items with 4 time bins.

```{r}
#get means for participants by condition for number of looks
msslooks <- filter(d, exclude == 0) %>%
  group_by(SID, phase_name, num_objs, familiarity, age_years) %>%
  summarise(num_looks = mean(num_looks))

#get means and CIs across participants for number of looks
mslooks <- filter(d, exclude == 0) %>%
  group_by(phase_name, familiarity, num_objs, age_years) %>%
  multi_boot_standard(col = "num_looks") 

#get means and CIs across conditions and participants for number of looks for first half vs. second half
mslooks_half <- filter(d, exclude == 0) %>%
  group_by(phase_name, familiarity, num_objs, first_half) %>%
  multi_boot_standard(col = "num_looks") 

msslooks_half <- filter(d, exclude == 0) %>%
  group_by(SID, phase_name, num_objs, familiarity, first_half) %>%
  summarise(num_looks = mean(num_looks))

#get means for participants by condition for number of looks: proportions
msslooks_sec <- filter(d, exclude == 0) %>%
  group_by(SID, phase_name, num_objs, familiarity, age_years) %>%
  summarise(looks_sec = mean(looks_sec))

#get means and CIs across participants for number of looks: proportions
mslooks_sec <- filter(d, exclude == 0) %>%
  group_by(phase_name, familiarity, num_objs, age_years) %>%
  multi_boot_standard(col = "looks_sec") 

#get means for participants by bilingual condition for social ref
mss <- filter(d, exclude == 0) %>%
  group_by(SID, phase_name, bilingual) %>%
  summarise(num_looks = mean(num_looks))

#get means and CIs across participants for social ref
ms <- filter(d, exclude == 0) %>%
  group_by(phase_name, bilingual) %>%
  multi_boot_standard(col = "num_looks") 


#plot bilingual
#plot presence or absence of social referencing.
ggplot(mss, aes(x = phase_name, y = num_looks, 
               col = bilingual)) + 
  geom_jitter(width = .3, height = .05) +
  geom_line(data = ms, aes(y = mean)) + 
  geom_pointrange(data = ms, 
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width =.1)) + 
  ylim(c(0,4)) + 
  xlab("") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))

#plot number of looks NO INDIVIDUAL DATA PLOTTED.
ggplot(msslooks, aes(x = phase_name, y = num_looks, 
               col = familiarity, group = familiarity)) + 
  geom_line(data = mslooks, aes(y = mean)) + 
  geom_pointrange(data = mslooks, 
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width =.1)) + 
  facet_grid(age_years ~ num_objs) + 
  ylim(c(0,2)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))

#plot number of looks based on half.
ggplot(msslooks_half, aes(x = phase_name, y = num_looks, 
               col = familiarity, group = familiarity)) + 
  geom_line(data = mslooks_half, aes(y = mean)) + 
  geom_pointrange(data = mslooks, 
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width =.1)) + 
  facet_grid(first_half ~ num_objs) + 
  ylim(c(0,2)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))

#plot looks per second.
ggplot(msslooks_sec, aes(x = phase_name, y = looks_sec, 
               col = familiarity, group = familiarity)) + 
  geom_line(data = mslooks_sec, aes(y = mean)) + 
  geom_pointrange(data = mslooks_sec, 
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width =.1)) + 
  facet_grid(age_years ~ num_objs) + 
  ylim(c(0,.75)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))

psych::describe(d$phase_length)
```

Get phase lengths.

```{r}
phase_lengths <- d %>% 
  group_by(phase_name) %>% 
  summarise(phase_length = mean(phase_length)) %>%
  mutate(time = cumsum(phase_length),
         middle_time = time - phase_length/2, 
         middle_time_s = middle_time / 1000)

ms <- left_join(ms, phase_lengths)
mss <- left_join(mss, phase_lengths)

#plot to include phase lenghts.
# ggplot(mss, aes(x = middle_time_s, y = social_ref, 
#                col = familiarity, group = familiarity)) + 
#   geom_jitter(width = .4, height = .05) +
#   geom_line(data = ms, aes(y = mean)) + 
#   geom_pointrange(data = ms, 
#                   aes(y = mean, ymin = ci_lower, ymax = ci_upper), 
#                   position = position_dodge(width =.1)) + 
#   facet_grid(.~num_objs) + 
#   ylim(c(0,1)) + 
#   xlim(c(0, 9)) + 
#   xlab("Time (s)") + 
#   ylab("Probability of social referencing") +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

Plot average phase lengths.

```{r}
#plot phase lenghts of four phases.
phase_lengths <- d %>% 
  group_by(phase_name) %>% 
  multi_boot_standard(col = "phase_length")

ggplot(phase_lengths, aes(x = phase_name, y = mean)) + 
  geom_bar(stat="identity") + 
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
             position = position_dodge(width = .9))+
  xlab("Phase") + 
  ylab("Phase Length (ms)") 

#plot phase lengths for 3 phases (2 and 3 collapsed)
phase_lengths_dc <- dc %>% 
  group_by(phase_name) %>% 
  multi_boot_standard(col = "phase_length")

ggplot(phase_lengths_dc, aes(x = phase_name, y = mean)) + 
  geom_bar(stat="identity") + 
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
             position = position_dodge(width = .9))+
  xlab("Phase") + 
  ylab("Phase Length (ms)") 
```

Plot phase lengths by condition by age. Slide-touch phase can be thought of to reflect decision time.

```{r}
msslengths <- filter(d, exclude == 0) %>%
  group_by(SID, phase_name, num_objs, familiarity, age_years) %>%
  summarise(phase_length = mean(phase_length))

mslengths <- filter(d, exclude == 0) %>%
  group_by(phase_name, familiarity, num_objs, age_years) %>%
  multi_boot_standard(col = "phase_length") 

ggplot(msslengths, aes(x = phase_name, y = phase_length, 
               col = familiarity, group = familiarity)) + 
  geom_line(data = mslengths, aes(y = mean)) + 
  geom_pointrange(data = mslengths, 
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width =.1)) + 
  facet_grid(age_years ~ num_objs) + 
  ylim(c(0,7500)) +
  xlab("Phase") + 
  ylab("Phase Length (ms)") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

#Planned analyses

Separate mixed-effects linear regression models for 3 phases.

Phase Label-Request
```{r lmer_lr, results="asis"}
lm <- lmer(num_looks ~ num_objs * familiarity * age_months +
              (1|SID),
              data = filter(dc, exclude == 0, phase_name == "label_request"))

tab <- kable(coef(summary(lm)), caption = "Mixed effects linear regression model predicting social referencing")
print(tab, type="html")
```

Phase Request-Touch
```{r lmer_rt, results="asis"}
lm <- lmer(num_looks ~ num_objs * familiarity * age_months +
              (1|SID),
              data = filter(dc, exclude == 0, phase_name == "request_touch"))

tab <- kable(coef(summary(lm)), caption = "Mixed effects linear regression model predicting social referencing")
print(tab, type="html")
```

Phase Touch-Response
```{r lmer_tr, results="asis"}
lm <- lmer(num_looks ~ num_objs * familiarity * age_years +
              (1|SID),

              data = filter(d, exclude == 0, phase_name == "touch_response"))

tab <- kable(coef(summary(lm)), caption = "Mixed effects linear regression model predicting social referencing")
print(tab, type="html")

coefs <- data.frame(coef(summary(lm)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

```

Omnibus model. Confirmitory plan is to look for 4-way interaction between number of ojects (1 vs 2), familiarity (novel vs familiar), phase (label vs request vs response). Study may be underpowered to detect 4-way interaction.
```{r lmer_om, results="asis"}
lm <- lmer(num_looks ~ num_objs * familiarity * phase_name * age_years +
              (1|SID),
              data = filter(d, exclude == 0))

tab <- kable(coef(summary(lm)), caption = "Mixed effects linear regression model predicting social referencing")
print(tab, type="html")

coefs <- data.frame(coef(summary(lm)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
```

Condition x age predicting decision latency (phase slide-touch).
```{r lmer_latency, results="asis"}
lm <- lmer(phase_length ~ num_objs * familiarity * age_months +
              (1|SID),
              data = filter(d, exclude == 0, phase_name == "slide_touch"))

tab <- kable(coef(summary(lm)), caption = "Mixed effects linear regression model predicting response latency")
print(tab, type="html")

coefs <- data.frame(coef(summary(lm)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
```

Condition x age predicting decision latency (phase touch-response).
```{r lmer_latency, results="asis"}
lm <- lmer(phase_length ~ num_objs * familiarity * age_months +
              (1|SID),
              data = filter(d, exclude == 0, phase_name == "touch_response"))

tab <- kable(coef(summary(lm)), caption = "Mixed effects linear regression model predicting response latency")
print(tab, type="html")

coefs <- data.frame(coef(summary(lm)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
```



```{r}
glm_mod <- glmer(social_ref ~ num_objs * familiarity * phase_name * age_months +
              (1|SID), family = "binomial",
              data = filter(dc, exclude == 0))

glm_maximal_mod <- glmer(social_ref ~ num_objs * familiarity * 
                           phase_name * age_months +
                           (num_objs * familiarity * phase_name | SID), 
                         family = "binomial",
                         data = filter(dc, exclude == 0))
```


```{r}
rt_maximal_mod <- lmer(num_looks ~ factor(num_objs) * familiarity * scale(age_months) +
                           (num_objs * familiarity | SID), 
                         data = filter(dc, 
                                       exclude == 0, 
                                       phase_name == "request_touch"))

tr_maximal_mod <- lmer(num_looks ~ factor(num_objs) * familiarity * scale(age_months) +
                           (num_objs * familiarity | SID), 
                         data = filter(dc, 
                                       exclude == 0, 
                                       phase_name == "touch_response"))

filter(dc, exclude == 0, phase_name == "request_touch") %>%
  group_by(age_years, num_objs, familiarity) %>%
  summarise(num_looks = mean(num_looks))

filter(dc, exclude == 0, phase_name == "touch_response") %>%
  group_by(age_years, num_objs, familiarity) %>%
  summarise(num_looks = mean(num_looks))

# takes a long time
omni_maximal_mod <- lmer(num_looks ~ factor(num_objs) * familiarity * 
                           scale(age_months) * phase_name +
                           (num_objs + familiarity + phase_name | SID), 
                         data = filter(d, exclude == 0))




```


```{r}
glm_maximal_mod <- glmer(social_ref ~ num_objs * familiarity * age_months +
                           (num_objs + familiarity | SID), 
                         family = "binomial",
                         data = filter(dc, 
                                       exclude == 0, 
                                       phase_name == "request_touch"))
```